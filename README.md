# Acropalypse detection and sanitization tools

You can use the python script `acropalypse_detection.py` or the yara rule `acropalypse_detection.yar` to detect cropped images affected by acropalypse:

```
$ for i in test_imgs/*; do python3 acropalypse_detection.py $i; done
test_imgs/windows10_snipping_tool_1_cropped.png
test_imgs/windows10_snipping_tool_2_cropped.png
test_imgs/windows11_1_cropped.png
test_imgs/windows11_2_cropped.png
```

```
$ yara acropalypse_detection.yar -r test_imgs/
acropalypse test_imgs//windows10_snipping_tool_1_cropped.png
acropalypse test_imgs//windows10_snipping_tool_2_cropped.png
acropalypse test_imgs//windows11_2_cropped.png
acropalypse test_imgs//windows11_1_cropped.png
```

The cropped images are valid PNG images that end with an IEND chunk.
But data from the original image remains after this chunk.
The detection script and rule search for another IEND chunk at the end of the file that corresponds to the original image.

You can sanitize affected images using `acropalypse_sanitizer.py`:

```
$ for i in test_imgs/*; do python3 acropalypse_sanitizer.py $i; done
Saving sanitized file as test_imgs/windows10_snipping_tool_1_cropped_sanitized.png
test_imgs/windows10_snipping_tool_1.png has no trailing bytes or original IEND chunk!
This file is not affected by acropalypse.
Saving sanitized file as test_imgs/windows10_snipping_tool_2_cropped_sanitized.png
test_imgs/windows10_snipping_tool_2.png has no trailing bytes or original IEND chunk!
This file is not affected by acropalypse.
Saving sanitized file as test_imgs/windows11_1_cropped_sanitized.png
test_imgs/windows11_1.png has no trailing bytes or original IEND chunk!
This file is not affected by acropalypse.
Saving sanitized file as test_imgs/windows11_2_cropped_sanitized.png
test_imgs/windows11_2.png has no trailing bytes or original IEND chunk!
This file is not affected by acropalypse.
```

This script removes the original data after the end of the cropped file making it impossible to recover the original content:

![Hex comparison between sanitized and vulnerable image.](/Screenshot%202023-03-22%20121216.png)

```
$ ls -la test_imgs/
total 804
drwxrwxr-x 2 octa octa   4096 mar 22 11:32 .
drwxrwxr-x 3 octa octa   4096 mar 22 11:28 ..
-rw-rw-r-- 1 octa octa  45077 mar 22 09:44 windows10_snipping_tool_1_cropped.png
-rw-rw-r-- 1 octa octa   6886 mar 22 11:32 windows10_snipping_tool_1_cropped_sanitized.png
-rw-rw-r-- 1 octa octa  45077 mar 22 09:43 windows10_snipping_tool_1.png
-rw-rw-r-- 1 octa octa  34484 mar 22 09:44 windows10_snipping_tool_2_cropped.png
-rw-rw-r-- 1 octa octa   5065 mar 22 11:32 windows10_snipping_tool_2_cropped_sanitized.png
-rw-rw-r-- 1 octa octa  34484 mar 22 09:44 windows10_snipping_tool_2.png
-rw-rw-r-- 1 octa octa 195988 mar 22 11:18 windows11_1_cropped.png
-rw-rw-r-- 1 octa octa   5183 mar 22 11:32 windows11_1_cropped_sanitized.png
-rw-rw-r-- 1 octa octa 195988 mar 22 11:16 windows11_1.png
-rw-rw-r-- 1 octa octa 109834 mar 22 11:26 windows11_2_cropped.png
-rw-rw-r-- 1 octa octa   1365 mar 22 11:32 windows11_2_cropped_sanitized.png
-rw-rw-r-- 1 octa octa 109834 mar 22 11:24 windows11_2.png
```

That is why the size of the sanitized images is much smaller and the cropped images have the same size as the original ones.

These scripts are based on https://gist.github.com/DavidBuchanan314/93de9d07f7fab494bcdf17c2bd6cef02

If you want to try to recover the original screenshots use https://acropalypse.app